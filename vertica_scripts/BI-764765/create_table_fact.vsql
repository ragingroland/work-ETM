create table DataPrime.ECom_WebAnalytics (
    CounterID int,
    DataInfo date,
    VisitID int,
    OrderID int,
    UserID int,
    RegUser int,
    NewUser int,
    Class206_Code varchar(8),
    ETMCliID int,
    CountryID int,
    RegionID int,
    CityID int,
    Device varchar(50),
    TrafficSourceFirst int,
    TrafficSourceAuto int,
    TrafficSourceLast int,
    TypeClient varchar(50),
    Class81_Code varchar(24),
    WatchProd int,
    QltAddProd int,
    WatchBucket int,
    QltCheckOut int,
    OrderDate date,
    QltPurchaseProd int,
    TotalSum float,
    DtTmRenew date,
    PrisePRZ float,
    QltPRZ int,
    PricePO float,
    QltPO int)
order by
    CounterID,
    CountryID,
    RegionID,
    CityID,
    TrafficSourceFirst,
    TrafficSourceAuto,
    TrafficSourceLast,
    DataInfo
    ---------
    VisitID,
    OrderID,
    UserID,
    RegUser,
    NewUser,
    Class206_Code,
    ETMCliID,
    Device,
    TypeClient,
    Class81_Code,
    WatchProd,
    QltAddProd,
    WatchBucket,
    QltCheckOut,
    OrderDate,
    QltPurchaseProd,
    TotalSum,
    DtTmRenew,
    PrisePRZ,
    QltPRZ,
    PricePO,
    QltPO
    ---------
segmented by hash (
    DataPrime.ECom_WebAnalytics.CounterID,
    DataPrime.ECom_WebAnalytics.CountryID,
    DataPrime.ECom_WebAnalytics.RegionID,
    DataPrime.ECom_WebAnalytics.CityID,
    DataPrime.ECom_WebAnalytics.TrafficSourceFirst,
    DataPrime.ECom_WebAnalytics.TrafficSourceAuto,
    DataPrime.ECom_WebAnalytics.TrafficSourceLast) all nodes ksafe;

comment on table DataPrime.ECom_WebAnalytics is 'Выгрузка веб-аналитики';
comment on column DataPrime.ECom_WebAnalytics.CounterID is 'ID счетчика';
comment on column DataPrime.ECom_WebAnalytics.DataInfo is 'Дата';
comment on column DataPrime.ECom_WebAnalytics.VisitID is 'ID визита';
comment on column DataPrime.ECom_WebAnalytics.OrderID is 'ID заказа';
comment on column DataPrime.ECom_WebAnalytics.UserID is 'ID пользователя';
comment on column DataPrime.ECom_WebAnalytics.RegUser is 'Авторизованный пользователь';
comment on column DataPrime.ECom_WebAnalytics.NewUser is 'Новый пользователь';
comment on column DataPrime.ECom_WebAnalytics.Class206_Code is 'Код класса 206-го классификатора';
comment on column DataPrime.ECom_WebAnalytics.ETMCliID is 'ID клиента ЭТМ';
comment on column DataPrime.ECom_WebAnalytics.CountryID is 'ID страны';
comment on column DataPrime.ECom_WebAnalytics.RegionID is 'ID региона';
comment on column DataPrime.ECom_WebAnalytics.CityID is 'ID города';
comment on column DataPrime.ECom_WebAnalytics.Device is 'Девайс';
comment on column DataPrime.ECom_WebAnalytics.TrafficSourceFirst is 'Источник трафика (Перв.)';
comment on column DataPrime.ECom_WebAnalytics.TrafficSourceAuto is 'Источник трафика (автоматический.)';
comment on column DataPrime.ECom_WebAnalytics.TrafficSourceLast is 'Источник трафика (Посл. Зн.)';
comment on column DataPrime.ECom_WebAnalytics.TypeClient is 'Тип клиента';
comment on column DataPrime.ECom_WebAnalytics.Class81_Code is 'Код класса 81-го классификатора';
comment on column DataPrime.ECom_WebAnalytics.WatchProd is 'Просмотр товаров';
comment on column DataPrime.ECom_WebAnalytics.QltAddProd is 'Добавление товара в корзину';
comment on column DataPrime.ECom_WebAnalytics.WatchBucket is 'Просмотр корзины';
comment on column DataPrime.ECom_WebAnalytics.QltCheckOut is 'Кол-во оформленных заказов';
comment on column DataPrime.ECom_WebAnalytics.OrderDate is 'Дата создания заказа';
comment on column DataPrime.ECom_WebAnalytics.QltPurchaseProd is 'Кол-во купленного товара';
comment on column DataPrime.ECom_WebAnalytics.TotalSum is 'Общая сумма товара';
comment on column DataPrime.ECom_WebAnalytics.DtTmRenew is 'Дата отгрузки';
comment on column DataPrime.ECom_WebAnalytics.PrisePRZ is 'Цена за ед. товара (ПРЗ)-размещенные';
comment on column DataPrime.ECom_WebAnalytics.QltPRZ is 'Количество (ПРЗ)';
comment on column DataPrime.ECom_WebAnalytics.PricePO is 'Цена за ед. товара (ПО) - отгруженные';
comment on column DataPrime.ECom_WebAnalytics.QltPO is 'Количество (ПО)';

create table DataPrime.ECom_Nomenclature (
    CounterID int,
    RgdCode int,
    DataInfo date,
    QltVisit int,
    TrafficSourceID int,
    SearchEngineRootID int,
    WatchCard int,
    QltAdd int,
    SumAdd int,
    QltClickReplace int,
    SumClickReplace int,
    QltPurchaseProd int,
    SumPurchaseProd int,
    QltRefusal int,
    RenomeYM int)
order by
    CounterID,
    TrafficSourceID,
    SearchEngineRootID,
    RgdCode,
    DataInfo
segmented by hash (
    DataPrime.ECom_Nomenclature.CounterID,
    DataPrime.ECom_Nomenclature.TrafficSourceID,
    DataPrime.ECom_Nomenclature.SearchEngineRootID,
    DataPrime.ECom_Nomenclature.RgdCode) all nodes ksafe;

comment on table DataPrime.ECom_Nomenclature is 'Номенклатурная выгрузка';
comment on column DataPrime.ECom_Nomenclature.CounterID is 'ID счетчика';
comment on column DataPrime.ECom_Nomenclature.RgdCode is 'Код товара';
comment on column DataPrime.ECom_Nomenclature.DataInfo is 'Дата';
comment on column DataPrime.ECom_Nomenclature.QltVisit is 'Кол-во визитов с КТ';
comment on column DataPrime.ECom_Nomenclature.TrafficSourceID is 'Источник траффика';
comment on column DataPrime.ECom_Nomenclature.SearchEngineRootID is 'Поисковая система';
comment on column DataPrime.ECom_Nomenclature.WatchCard is 'Кол-во просмотров карточки';
comment on column DataPrime.ECom_Nomenclature.QltAdd is 'Кол-во добавлений в корзину';
comment on column DataPrime.ECom_Nomenclature.SumAdd is 'Кол-во добавлений в корзину (шт)';
comment on column DataPrime.ECom_Nomenclature.QltClickReplace is 'Клик на подобрать замену';
comment on column DataPrime.ECom_Nomenclature.SumClickReplace is 'Клик на подобрать замену (шт.)';
comment on column DataPrime.ECom_Nomenclature.QltPurchaseProd is 'Кол-во купленного товара';
comment on column DataPrime.ECom_Nomenclature.SumPurchaseProd is 'Кол-во купленного товара (шт.)';
comment on column DataPrime.ECom_Nomenclature.QltRefusal is 'Кол-во отказов';
comment on column DataPrime.ECom_Nomenclature.RenomeYM is 'Фиксация изменения названия на ЯМ (true/false) если по коду товара (колонка 2 - RgdCode) на предыдущую дату (от даты в колонке 3) произошло изменение названия ЯМ, то фиксируем 1 (true), в ином случае 0 (false)';

create table DataPrime.ECom_AdConversion (
    TypeClient int,
    CampaignID int,
    CategoryID int,
    RgdCode int,
    UserID int,
    TrafficSourceAuto int,
    TrafficSourceLast int,
    WatchProd int,
    QltAddProd int,
    QltPurchaseProd int,
    TotalSum int)
order by
    CampaignID,
    CategoryID,
    TrafficSourceAuto,
    TrafficSourceLast,
    RgdCode
segmented by hash (
    DataPrime.ECom_AdConversion.CampaignID,
    DataPrime.ECom_AdConversion.CategoryID,
    DataPrime.ECom_AdConversion.TrafficSourceAuto,
    DataPrime.ECom_AdConversion.TrafficSourceLast) all nodes ksafe;

comment on table DataPrime.ECom_AdConversion is 'Рекламная выгрузка';
comment on column DataPrime.ECom_AdConversion.TypeClient is 'Тип клиента';
comment on column DataPrime.ECom_AdConversion.CampaignID is 'ID кампании';
comment on column DataPrime.ECom_AdConversion.CategoryID is 'ID категории';
comment on column DataPrime.ECom_AdConversion.RgdCode is 'Код товара';
comment on column DataPrime.ECom_AdConversion.UserID is 'ID пользователя';
comment on column DataPrime.ECom_AdConversion.TrafficSourceAuto is 'Источник трафика (автоматический.)';
comment on column DataPrime.ECom_AdConversion.TrafficSourceLast is 'Источник трафика (Посл. Зн.)';
comment on column DataPrime.ECom_AdConversion.WatchProd is 'Просмотр товаров';
comment on column DataPrime.ECom_AdConversion.QltAddProd is 'Добавление товара в корзину';
comment on column DataPrime.ECom_AdConversion.QltPurchaseProd is 'Кол-во купленного товара';
comment on column DataPrime.ECom_AdConversion.TotalSum is 'Общая сумма товара';

create table DataPrime.ECom_DirectIndicators (
    DataInfo date,
    CampaignID int,
    CategoryID int,
    Impressions int,
    Cliks int,
    Cost float,
    Visits int,
    Transactions int,
    B2B_Transactions int,
    B2С_Transactions int,
    Purchase_revenue float,
    B2B_revenue float,
    B2С_revenue float,
    goal_specification int,
    goal_smeta int,
    goal_registration_B2B int,
    goal_registration_B2C int,
    goal_specification_В2В int,
    goal_specification_В2С int,
    goal_smeta_B2B int,
    goal_smeta_B2С int)
order by
    CampaignID,
    CategoryID,
    DataInfo
segmented by hash (
    DataPrime.ECom_DirectIndicators.CampaignID,
    DataPrime.ECom_DirectIndicators.CategoryID) all nodes ksafe;

comment on table DataPrime.ECom_DirectIndicators is 'Выгрузка индикаторов';
comment on column DataPrime.ECom_DirectIndicators.DataInfo is 'Дата';
comment on column DataPrime.ECom_DirectIndicators.CampaignID is 'ID кампании';
comment on column DataPrime.ECom_DirectIndicators.CategoryID is 'ID категории';
comment on column DataPrime.ECom_DirectIndicators.Impressions is 'Количество показов';
comment on column DataPrime.ECom_DirectIndicators.Cliks is 'Количество кликов';
comment on column DataPrime.ECom_DirectIndicators.Cost is 'Стоимость кликов=расход';
comment on column DataPrime.ECom_DirectIndicators.Visits is 'Количество визитов';
comment on column DataPrime.ECom_DirectIndicators.Transactions is 'Количество заказов';
comment on column DataPrime.ECom_DirectIndicators.B2B_Transactions is 'Количество заказов ЮЛ';
comment on column DataPrime.ECom_DirectIndicators.B2С_Transactions is 'Количество заказов ФЛ';
comment on column DataPrime.ECom_DirectIndicators.Purchase_revenue is 'Сумма заказов=доход';
comment on column DataPrime.ECom_DirectIndicators.B2B_revenue is 'Сумма заказов ЮЛ';
comment on column DataPrime.ECom_DirectIndicators.B2С_revenue is 'Сумма заказов ФЛ';
comment on column DataPrime.ECom_DirectIndicators.goal_specification is 'Количество достижений цели "создать спецификацию"';
comment on column DataPrime.ECom_DirectIndicators.goal_smeta is 'количество достижений цели "создать смету"';
comment on column DataPrime.ECom_DirectIndicators.goal_registration_B2B is 'Количество достижений цели "регистрация ЮЛ"';
comment on column DataPrime.ECom_DirectIndicators.goal_registration_B2C is 'Количество достижений цели "регистрация ФЛ"';
comment on column DataPrime.ECom_DirectIndicators.goal_specification_В2В is 'Количество достижений цели "создать спецификацию" ЮЛ';
comment on column DataPrime.ECom_DirectIndicators.goal_specification_В2С is 'Количество достижений цели "создать спецификацию" ФЛ';
comment on column DataPrime.ECom_DirectIndicators.goal_smeta_B2B is 'Количество достижений цели "создать смету" ЮЛ';
comment on column DataPrime.ECom_DirectIndicators.goal_smeta_B2С is 'Количество достижений цели "создать смету" ФЛ';

GRANT USAGE ON SCHEMA public, DataPrime, DataMart TO RO_public_role;
GRANT SELECT ON ALL TABLES IN SCHEMA public, DataPrime, DataMart TO RO_public_role;
GRANT ALL ON SCHEMA public, DataPrime, DataMart TO RW_public_role;
GRANT ALL ON ALL TABLES IN SCHEMA public, DataPrime, DataMart TO RW_public_role;
GRANT USAGE ON SCHEMA public, DataPrime TO etl_ed_role;
GRANT SELECT ON ALL TABLES IN SCHEMA public, DataPrime  TO etl_ed_role;
GRANT ALL ON SCHEMA DataMart TO etl_ed_role;
GRANT ALL ON ALL TABLES IN SCHEMA DataMart TO etl_ed_role;
